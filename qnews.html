<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qNews Newsletter | reTHINKit</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="auth.css">
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_bWF0dXJlLWFuY2hvdnktNTQuY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://mature-anchovy-54.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js" type="text/javascript"></script>
    <style>
        .newsletter-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .newsletter-hero {
            padding: var(--space-2xl) var(--space-lg);
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(17, 24, 39, 0.5) 100%);
        }
        
        .newsletter-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
            filter: drop-shadow(0 0 30px var(--orange-glow));
        }
        
        .newsletter-title {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: var(--space-md);
            color: var(--orange);
        }
        
        .newsletter-subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto var(--space-xl);
            line-height: 1.6;
        }
        
        .subscription-container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
        }
        
        .subscription-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: var(--space-xl);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }
        
        .subscription-status {
            text-align: center;
            padding: var(--space-lg);
            border-radius: 12px;
            margin-bottom: var(--space-lg);
        }
        
        .subscription-status.subscribed {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .subscription-status.not-subscribed {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }
        
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
            margin: var(--space-lg) 0;
        }
        
        .topic-checkbox {
            position: relative;
        }
        
        .topic-checkbox input {
            display: none;
        }
        
        .topic-label {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .topic-checkbox input:checked + .topic-label {
            background: rgba(255, 149, 0, 0.15);
            border-color: var(--orange);
        }
        
        .topic-label:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }
        
        .topic-icon {
            font-size: 1.5rem;
        }
        
        .topic-name {
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .frequency-select {
            margin: var(--space-lg) 0;
        }
        
        .frequency-select label {
            display: block;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .frequency-select select {
            width: 100%;
            padding: var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid rgba(255, 149, 0, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .subscribe-btn {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background: var(--orange);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .subscribe-btn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 149, 0, 0.4);
        }
        
        .subscribe-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-required {
            text-align: center;
            padding: var(--space-xl);
        }
        
        .auth-required p {
            margin-bottom: var(--space-lg);
            color: var(--text-secondary);
        }
        
        .message {
            padding: var(--space-md);
            border-radius: 8px;
            margin: var(--space-md) 0;
            text-align: center;
        }
        
        .message.success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .loading {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }
    </style>
</head>
<body class="newsletter-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <img src="logo.png" alt="reTHINKit Logo" class="logo-icon">
                <span class="logo-text">re<span class="logo-highlight">THINK</span>it</span>
            </a>
            <div class="nav-links">
                <a href="qassist.html" class="nav-link"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 2V4M15 2V4M9 20V22M15 20V22M2 9H4M2 15H4M20 9H22M20 15H22"/></svg></span> qAssist</a>
                <a href="qreview.html" class="nav-link"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 12L11 14L15 10"/></svg></span> qReview</a>
                <a href="qstrategy.html" class="nav-link"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg></span> qStrategy</a>
                <a href="qinvest.html" class="nav-link"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17L9 11L13 15L21 7"/><path d="M17 7H21V11"/></svg></span> qInvest</a>
                <a href="qnews.html" class="nav-link active"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20H21"/><path d="M16.5 3.5C16.8978 3.10217 17.4374 2.87868 18 2.87868C18.2786 2.87868 18.5544 2.93355 18.8118 3.04015C19.0692 3.14674 19.303 3.303 19.5 3.5C19.697 3.697 19.8533 3.93085 19.9599 4.18822C20.0665 4.44558 20.1214 4.72142 20.1214 5C20.1214 5.27858 20.0665 5.55442 19.9599 5.81178C19.8533 6.06915 19.697 6.303 19.5 6.5L7 19L3 20L4 16L16.5 3.5Z"/></svg></span> qNews</a>
                <a href="investors.html" class="nav-link"><span class="nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.292 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg></span> Investors</a>
            </div>
            <div class="nav-actions">
                <!-- Auth buttons inserted by auth.js -->
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="newsletter-hero">
        <div class="newsletter-icon">üì¨</div>
        <h1 class="newsletter-title">qNews Newsletter</h1>
        <p class="newsletter-subtitle">
            Get curated insights on AI, startups, investing, and technology delivered to your inbox. 
            Personalized content based on your interests.
        </p>
    </div>

    <!-- Subscription Form -->
    <div class="subscription-container">
        <div id="subscriptionContent" class="loading">
            <p>Loading...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© 2025 reTHINKit. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
        const API_URL = 'https://qnews-newsletter-api.ulrich-8db.workers.dev';
        let availableTopics = [];
        let currentSubscription = null;

        // Load topics and subscription status
        async function loadPage() {
            const container = document.getElementById('subscriptionContent');
            
            // Wait for Clerk to initialize
            if (!window.Clerk || !window.Clerk.loaded) {
                setTimeout(loadPage, 100);
                return;
            }

            const user = window.Clerk.user;

            if (!user) {
                // Not logged in - show auth required message
                container.innerHTML = `
                    <div class="auth-required subscription-card">
                        <h2>Sign in to subscribe</h2>
                        <p>Create a free account to personalize your newsletter and start receiving curated content.</p>
                        <button class="subscribe-btn" onclick="signUp()">Create Free Account</button>
                        <p style="margin-top: var(--space-md); font-size: 0.9rem;">
                            Already have an account? <a href="#" onclick="signIn(); return false;" style="color: var(--orange)">Sign in</a>
                        </p>
                    </div>
                `;
                return;
            }

            // Load topics and subscription status
            try {
                const [topicsRes, subRes] = await Promise.all([
                    fetch(`${API_URL}/api/topics`),
                    getSubscriptionStatus()
                ]);

                availableTopics = (await topicsRes.json()).topics;
                currentSubscription = subRes;

                renderSubscriptionForm();
            } catch (error) {
                console.error('Error loading page:', error);
                container.innerHTML = `
                    <div class="message error">
                        Failed to load subscription data. Make sure the API server is running.
                    </div>
                `;
            }
        }

        // Get subscription status
        async function getSubscriptionStatus() {
            try {
                const session = await window.Clerk.session;
                const token = await session.getToken();

                const res = await fetch(`${API_URL}/api/subscription`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!res.ok) throw new Error('Failed to fetch subscription');
                return await res.json();
            } catch (error) {
                console.error('Error getting subscription:', error);
                return { subscribed: false, subscriber: null };
            }
        }

        // Render subscription form
        function renderSubscriptionForm() {
            const container = document.getElementById('subscriptionContent');
            const isSubscribed = currentSubscription.subscribed;
            const subscriber = currentSubscription.subscriber;

            const selectedTopics = subscriber?.topics || [];
            const frequency = subscriber?.frequency || 'weekly';

            container.innerHTML = `
                <div class="subscription-card">
                    <div class="subscription-status ${isSubscribed ? 'subscribed' : 'not-subscribed'}">
                        <h3>${isSubscribed ? '‚úÖ You\'re subscribed!' : 'üì¨ Subscribe to our newsletter'}</h3>
                        <p>${isSubscribed 
                            ? 'You\'ll receive personalized content based on your selected topics.' 
                            : 'Select your interests and choose your preferred frequency.'
                        }</p>
                    </div>

                    <div id="messageArea"></div>

                    <h3 style="margin-bottom: var(--space-md);">Choose Your Topics</h3>
                    <div class="topics-grid">
                        ${availableTopics.map(topic => `
                            <div class="topic-checkbox">
                                <input type="checkbox" id="topic-${topic.id}" value="${topic.id}" 
                                    ${selectedTopics.includes(topic.id) ? 'checked' : ''}>
                                <label class="topic-label" for="topic-${topic.id}">
                                    <span class="topic-icon">${topic.icon}</span>
                                    <span class="topic-name">${topic.label}</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>

                    <div class="frequency-select">
                        <label for="frequency">Newsletter Frequency</label>
                        <select id="frequency">
                            <option value="daily" ${frequency === 'daily' ? 'selected' : ''}>Daily Digest</option>
                            <option value="weekly" ${frequency === 'weekly' ? 'selected' : ''}>Weekly Roundup</option>
                            <option value="monthly" ${frequency === 'monthly' ? 'selected' : ''}>Monthly Review</option>
                        </select>
                    </div>

                    <button class="subscribe-btn" id="subscribeBtn" onclick="handleSubscribe()">
                        ${isSubscribed ? 'Update Preferences' : 'Subscribe Now'}
                    </button>

                    ${isSubscribed ? `
                        <button class="subscribe-btn" style="margin-top: var(--space-md); background: var(--bg-secondary); color: var(--text-secondary);" onclick="handleUnsubscribe()">
                            Unsubscribe
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Handle subscribe/update
        async function handleSubscribe() {
            const btn = document.getElementById('subscribeBtn');
            const messageArea = document.getElementById('messageArea');
            
            // Get selected topics
            const checkboxes = document.querySelectorAll('.topic-checkbox input:checked');
            const topics = Array.from(checkboxes).map(cb => cb.value);

            if (topics.length === 0) {
                messageArea.innerHTML = '<div class="message error">Please select at least one topic</div>';
                return;
            }

            const frequency = document.getElementById('frequency').value;

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const session = await window.Clerk.session;
                const token = await session.getToken();

                const res = await fetch(`${API_URL}/api/subscription/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ topics, frequency })
                });

                const result = await res.json();

                if (result.success) {
                    messageArea.innerHTML = '<div class="message success">‚úÖ Subscription updated successfully!</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to subscribe');
                }
            } catch (error) {
                console.error('Subscribe error:', error);
                messageArea.innerHTML = `<div class="message error">‚ùå ${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = currentSubscription.subscribed ? 'Update Preferences' : 'Subscribe Now';
            }
        }

        // Handle unsubscribe
        async function handleUnsubscribe() {
            if (!confirm('Are you sure you want to unsubscribe?')) return;

            const messageArea = document.getElementById('messageArea');

            try {
                const session = await window.Clerk.session;
                const token = await session.getToken();

                const res = await fetch(`${API_URL}/api/subscription/unsubscribe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });

                const result = await res.json();

                if (result.success) {
                    messageArea.innerHTML = '<div class="message success">‚úÖ You\'ve been unsubscribed</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to unsubscribe');
                }
            } catch (error) {
                console.error('Unsubscribe error:', error);
                messageArea.innerHTML = `<div class="message error">‚ùå ${error.message}</div>`;
            }
        }

        // Initialize when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadPage);
        } else {
            loadPage();
        }
    </script>
</body>
</html>
